<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>AI Chat ‚Äî Camera + Trace + Streaming</title>

  <style>
    /* ==========================================================
       CORE VARS
    ========================================================== */
    :root{
      --bg-primary:#F2F2F7;
      --text-primary:#1D1D1F;
      --text-secondary:#86868B;
      --accent-blue:#007AFF;
      --danger-red:#FF3B30;

      --sidebar-bg:rgba(242,242,247,.95);
      --safe-bottom:env(safe-area-inset-bottom,20px);
      --safe-top:env(safe-area-inset-top,20px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; margin:0; padding:0; }
    body{
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background:var(--bg-primary);
      background-image: radial-gradient(circle at 50% -20%, rgba(0,122,255,.15) 0%, transparent 60%);
      background-attachment: fixed;
      color:var(--text-primary);
      height:100dvh;
      overflow:hidden;
      display:flex;
    }

    /* ==========================================================
       AUTH SCREEN
    ========================================================== */
    #auth-screen{
      position:fixed; inset:0; z-index:5000;
      background:rgba(242,242,247,.98);
      backdrop-filter:blur(20px);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:20px;
      transition:opacity .4s, visibility .4s;
    }
    #auth-screen.hidden{ opacity:0; visibility:hidden; pointer-events:none; }

    .auth-card{
      background:#fff;
      width:100%; max-width:360px;
      padding:30px;
      border-radius:24px;
      box-shadow:0 10px 40px rgba(0,0,0,.08);
      text-align:center;
    }
    .auth-logo{ font-size:40px; margin-bottom:10px; }
    .auth-title{ font-size:22px; font-weight:800; margin-bottom:18px; }
    .error-msg{
      color:var(--danger-red);
      font-size:14px;
      margin-bottom:12px;
      min-height:18px;
      font-weight:700;
    }
    .input-group{
      width:100%;
      margin-bottom:12px;
      border:1px solid #E5E5EA;
      border-radius:12px;
      background:#F9F9F9;
      display:flex;
      align-items:center;
      padding-right:10px;
      transition:.2s;
      position:relative;
    }
    .input-group:focus-within{ border-color:var(--accent-blue); background:#fff; }
    .at-symbol{ padding-left:14px; padding-right:2px; color:var(--text-secondary); font-weight:700; }
    .auth-input{
      width:100%;
      padding:14px;
      border:none;
      outline:none;
      background:transparent;
      font-size:16px;
    }
    .toggle-pass-btn{
      background:none;
      border:none;
      cursor:pointer;
      padding:5px;
      color:var(--text-secondary);
      display:flex;
      align-items:center;
    }
    .auth-btn{
      width:100%;
      padding:14px;
      margin-top:8px;
      background:var(--accent-blue);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .auth-switch{
      margin-top:18px;
      font-size:14px;
      color:var(--text-secondary);
      cursor:pointer;
    }
    .auth-switch span{ color:var(--accent-blue); font-weight:800; }
    .reset-db-btn{
      margin-top:24px;
      font-size:12px;
      color:var(--danger-red);
      background:none;
      border:none;
      cursor:pointer;
      opacity:.7;
      text-decoration:underline;
    }

    /* ==========================================================
       PROFILE MODAL
    ========================================================== */
    #profile-modal{
      position:fixed; inset:0; z-index:4000;
      background:rgba(0,0,0,.4);
      backdrop-filter:blur(5px);
      display:flex; align-items:center; justify-content:center;
      opacity:0; visibility:hidden; transition:.3s;
    }
    #profile-modal.active{ opacity:1; visibility:visible; }

    .profile-card{
      background:#fff;
      width:90%; max-width:420px;
      border-radius:24px;
      padding:24px;
      box-shadow:0 20px 50px rgba(0,0,0,.2);
      display:flex;
      flex-direction:column;
      align-items:center;
      transform:scale(.92);
      transition:.3s cubic-bezier(.175,.885,.32,1.275);
    }
    #profile-modal.active .profile-card{ transform:scale(1); }

    .profile-header{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .profile-title{ font-size:20px; font-weight:900; }
    .close-btn{
      background:#f0f0f0;
      border:none;
      width:32px;
      height:32px;
      border-radius:50%;
      cursor:pointer;
      font-weight:900;
    }

    .avatar-edit-area{
      position:relative;
      margin-bottom:16px;
      cursor:pointer;
      width:104px; height:104px;
    }
    .current-avatar-lg{
      width:100%; height:100%;
      border-radius:50%;
      background:#eee;
      border:4px solid #fff;
      box-shadow:0 5px 15px rgba(0,0,0,.1);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:52px;
      overflow:hidden;
      pointer-events:none;
    }
    .current-avatar-lg img{ width:100%; height:100%; object-fit:cover; }
    .edit-badge{
      position:absolute; bottom:0; right:0;
      background:var(--accent-blue);
      color:#fff;
      border:2px solid #fff;
      width:32px; height:32px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }

    .avatar-options{
      display:flex;
      gap:10px;
      width:100%;
      justify-content:center;
      margin-bottom:16px;
    }
    .avatar-option-btn{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #eee;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition:.2s;
      font-weight:800;
    }
    .avatar-option-btn:active{ background:#f0f0f0; transform:scale(.98); }
    #avatar-upload{ display:none; }

    .profile-field{ width:100%; margin-bottom:12px; text-align:left; }
    .field-label{ font-size:13px; color:var(--text-secondary); margin-bottom:6px; display:block; font-weight:700; }
    .field-value{
      font-size:16px;
      font-weight:900;
      padding:10px;
      background:#f9f9f9;
      border-radius:12px;
      color:var(--accent-blue);
    }

    .logout-btn{
      width:100%;
      margin-top:6px;
      color:var(--danger-red);
      background:rgba(255,59,48,.1);
      padding:12px;
      border-radius:12px;
      border:none;
      font-weight:900;
      cursor:pointer;
    }

    /* ==========================================================
       SIDEBAR
    ========================================================== */
    .sidebar{
      position:fixed; top:0; left:0; bottom:0;
      width:300px;
      background:var(--sidebar-bg);
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      border-right:1px solid rgba(0,0,0,.1);
      transform:translateX(-100%);
      transition:transform .35s cubic-bezier(.25,1,.5,1);
      z-index:2000;
      display:flex;
      flex-direction:column;
      padding-top:max(20px, var(--safe-top));
    }
    .sidebar.open{ transform:translateX(0); }

    .sidebar-header{ padding:16px; display:flex; flex-direction:column; gap:12px; }

    .sidebar-user{
      display:flex; align-items:center; gap:12px;
      padding:10px;
      border-radius:12px;
      transition:.2s;
      cursor:pointer;
    }
    .sidebar-user:active{ background:rgba(0,0,0,.05); }

    .sidebar-avatar{
      width:48px; height:48px;
      border-radius:50%;
      background:#ddd;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      pointer-events:none;
    }
    .sidebar-avatar img{ width:100%; height:100%; object-fit:cover; }

    .sidebar-info{ display:flex; flex-direction:column; pointer-events:none; }
    .sidebar-username{ font-weight:900; font-size:16px; color:var(--accent-blue); }
    .sidebar-status{ font-size:13px; color:var(--text-secondary); }

    .new-chat-btn{
      background:var(--text-primary);
      color:#fff;
      border:none;
      padding:12px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .search-box{
      background:rgba(118,118,128,.12);
      border-radius:12px;
      padding:8px 12px;
      display:flex; align-items:center;
    }
    .search-box input{
      border:none; background:transparent;
      width:100%;
      outline:none;
      font-size:16px;
      color:var(--text-primary);
    }

    .chat-list{ flex:1; overflow-y:auto; padding:10px 16px; }
    .chat-item{
      padding:12px 14px;
      margin-bottom:6px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:background .2s;
      font-size:15px;
    }
    .chat-item.active{
      background:rgba(0,122,255,.15);
      color:var(--accent-blue);
      font-weight:900;
    }
    .chat-title{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:160px;
    }
    .chat-actions{ display:flex; gap:4px; opacity:0; transition:opacity .2s; }
    .chat-item:hover .chat-actions,
    .chat-item.active .chat-actions{ opacity:1; }

    .action-icon{
      background:none;
      border:none;
      cursor:pointer;
      padding:4px 6px;
      color:var(--text-secondary);
      transition:.2s;
      font-weight:900;
      font-size:14px;
    }
    .action-icon:hover{ color:var(--text-primary); }
    .action-icon.delete:hover{ color:var(--danger-red); }

    .sidebar-footer{
      padding:16px;
      border-top:1px solid rgba(0,0,0,.06);
    }
    .logout-btn-sidebar{
      width:100%;
      color:var(--danger-red);
      background:rgba(255,59,48,.1);
      padding:12px;
      border-radius:12px;
      border:none;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.2);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s;
      z-index:1500;
    }
    .overlay.active{ opacity:1; pointer-events:auto; }

    /* ==========================================================
       MAIN UI
    ========================================================== */
    .main-content{
      flex:1;
      display:flex;
      flex-direction:column;
      position:relative;
      width:100%;
    }

    .top-bar{
      position:absolute; top:0; left:0; right:0;
      height:60px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 16px;
      padding-top:var(--safe-top);
      z-index:100;
      background:linear-gradient(to bottom, var(--bg-primary) 80%, transparent);
      pointer-events:none;
    }

    .icon-btn{
      width:40px;
      height:40px;
      border-radius:50%;
      border:none;
      background:rgba(255,255,255,.8);
      backdrop-filter:blur(10px);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:var(--text-primary);
      position:relative;
      overflow:hidden;
      pointer-events:auto;
    }
    .icon-btn > *{ pointer-events:none; }
    .icon-btn svg{ width:22px; height:22px; fill:currentColor; }

    .scroll-container{
      flex:1;
      overflow-y:auto;
      padding:80px 20px 170px 20px;
      scroll-behavior:smooth;
    }

    header{ margin-bottom:26px; text-align:center; }
    h1{ font-size:28px; font-weight:900; margin-bottom:6px; }
    .subtitle{ font-size:15px; color:var(--text-secondary); }

    #chat-stream{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-width:800px;
      margin:0 auto;
      width:100%;
    }

    /* message rows */
    .message-row{ display:flex; width:100%; }
    .message-row.user{ justify-content:flex-end; }
    .message-row.ai{ justify-content:flex-start; }

    .message{
      max-width:85%;
      padding:12px 18px;
      font-size:16px;
      line-height:1.5;
      border-radius:20px;
      box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    .message.user{
      background:var(--accent-blue);
      color:#fff;
      border-bottom-right-radius:4px;
    }
    .message.ai{
      background:#fff;
      color:#000;
      border-bottom-left-radius:4px;
      overflow:hidden;
      min-width:200px;
    }

    /* AI result layout */
    .result-card{ display:flex; flex-direction:column; }
    .result-title{ font-weight:900; font-size:18px; margin-bottom:8px; }
    .result-text{ font-size:16px; color:#333; white-space:pre-wrap; min-height:20px; }

    /* User image card */
    .user-image-card{
      width:240px;
      max-width:70vw;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.35);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
    .user-image-card img{ width:100%; height:160px; object-fit:cover; display:block; }
    .user-image-caption{
      padding:10px 12px;
      background:rgba(0,0,0,.12);
      backdrop-filter:blur(10px);
      font-size:14px;
      color:#fff;
      font-weight:800;
    }

    /* ==========================================================
       ONE TRACE BLOCK (like ChatGPT ‚ÄúAnalyzing image‚Äù)
    ========================================================== */
    .trace-card{
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      max-width: 800px;
      width:100%;
    }
    .trace-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .trace-title{
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:16px;
      margin-bottom:4px;
    }
    .trace-sub{
      color: var(--text-secondary);
      font-size: 14px;
      font-weight:700;
    }
    .trace-body{ margin-top: 10px; }
    .trace-step{
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(118,118,128,.08);
      margin-bottom: 8px;
    }
    .trace-step .t1{ font-weight:900; margin-bottom:4px; }
    .trace-step .t2{ color: var(--text-secondary); font-size: 14px; font-weight:700; }
    .trace-code{
      margin-top:8px;
      background:#0b0b0f;
      color:#d8d8ff;
      border-radius:12px;
      padding:10px;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre;
    }
    .trace-preview{
      width:100%;
      height:180px;
      border-radius:12px;
      object-fit:cover;
      margin-top:8px;
      background:#f0f0f0;
    }
    .trace-btn{
      background:none;
      border:none;
      cursor:pointer;
      color: var(--accent-blue);
      font-weight:900;
      font-size:14px;
      padding:6px 8px;
      border-radius:10px;
    }
    .trace-btn:active{ background: rgba(0,122,255,.12); }

    /* ==========================================================
       INPUT BAR (avatar + camera + pending thumb + send/stop)
    ========================================================== */
    .input-sheet-container{
      position:fixed;
      bottom:0; left:0; right:0;
      padding:0 16px calc(var(--safe-bottom) + 10px) 16px;
      z-index:1000;
      pointer-events:none;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      gap:8px;
    }

    .input-avatar-btn{
      width:44px; height:44px;
      border-radius:50%;
      background:#ddd;
      overflow:hidden;
      pointer-events:auto;
      flex-shrink:0;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      border:2px solid #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
    }
    .input-avatar-btn img{ width:100%; height:100%; object-fit:cover; }

    .input-wrapper{
      pointer-events:auto;
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(40px) saturate(180%);
      border-radius:32px;
      padding:6px 6px 6px 12px;
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.5);
      box-shadow:0 8px 32px rgba(0,0,0,.12);
      width:100%;
      max-width:800px;
      flex:1;
    }

    .mini-btn{
      width:44px; height:44px;
      border-radius:50%;
      border:none;
      background:rgba(118,118,128,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
    }
    .mini-btn svg{ width:20px; height:20px; fill:var(--text-primary); }
    .mini-btn:active{ transform:scale(.98); }

    #camera-input{ display:none; }

    .pending-thumb{
      width:44px; height:44px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      background:#f0f0f0;
      flex-shrink:0;
      display:none;
      position:relative;
    }
    .pending-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pending-thumb button{
      position:absolute; top:4px; right:4px;
      width:18px; height:18px;
      border-radius:50%;
      border:none;
      background:rgba(0,0,0,.55);
      color:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex; align-items:center; justify-content:center;
      line-height:18px;
    }

    #user-input{
      flex:1;
      border:none;
      background:transparent;
      font-size:17px;
      outline:none;
      padding-right:6px;
      height:44px;
      color:#000;
    }

    .action-btn{
      width:44px; height:44px;
      border-radius:50%;
      border:none;
      background:var(--text-primary);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
      position:relative;
      transition:background .25s;
    }
    .icon{
      position:absolute;
      transition:transform .25s, opacity .25s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .icon svg{ width:20px; height:20px; fill:#fff; }

    .action-btn.state-send .icon-send{ opacity:1; transform:scale(1); }
    .action-btn.state-send .icon-stop{ opacity:0; transform:scale(.5); }

    .action-btn.state-stop{ background:var(--text-secondary); }
    .action-btn.state-stop .icon-send{ opacity:0; transform:scale(.5); }
    .action-btn.state-stop .icon-stop{ opacity:1; transform:scale(1); }

    .action-btn.state-loading .icon{ opacity:0; }
    .action-btn.state-loading::after{
      content:"";
      width:18px; height:18px;
      border:2px solid rgba(255,255,255,.3);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin .8s linear infinite;
      position:absolute;
    }

    @keyframes spin{ to{ transform:rotate(360deg); } }
  </style>
</head>

<body>

  <!-- ========================= AUTH ========================= -->
  <div id="auth-screen">
    <div class="auth-card">
      <div class="auth-logo">üçé</div>
      <div class="auth-title" id="auth-title">–í—Ö–æ–¥</div>
      <div class="error-msg" id="auth-error"></div>

      <div class="input-group">
        <span class="at-symbol">@</span>
        <input type="text" class="auth-input" id="auth-username" placeholder="username" autocomplete="off" />
      </div>

      <div class="input-group">
        <input type="password" class="auth-input" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding-left:14px;" />
        <button class="toggle-pass-btn" onclick="Auth.togglePasswordVisibility()" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
          </svg>
        </button>
      </div>

      <button class="auth-btn" id="auth-action-btn">–í–æ–π—Ç–∏</button>
      <div class="auth-switch" id="auth-toggle">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span></div>

      <button class="reset-db-btn" onclick="Auth.resetAllData()">‚ö† –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>

  <!-- ========================= PROFILE MODAL ========================= -->
  <div id="profile-modal">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-title">–ê–∫–∫–∞—É–Ω—Ç</div>
        <button class="close-btn" onclick="Profile.close()">‚úï</button>
      </div>

      <div class="avatar-edit-area" onclick="Profile.triggerUpload()" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
        <div class="current-avatar-lg" id="profile-avatar-display">üë§</div>
        <div class="edit-badge">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
        </div>
      </div>

      <div class="avatar-options">
        <button class="avatar-option-btn" onclick="Profile.triggerUpload()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button class="avatar-option-btn" onclick="Profile.setRandomEmoji()">üé≤ –≠–º–æ–¥–∑–∏</button>
      </div>
      <input type="file" id="avatar-upload" accept="image/*" />

      <div class="profile-field">
        <span class="field-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
        <div class="field-value" id="profile-username">@user</div>
      </div>

      <button class="logout-btn" onclick="Auth.logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- ========================= OVERLAY ========================= -->
  <div class="overlay" id="overlay"></div>

  <!-- ========================= SIDEBAR ========================= -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-user" onclick="Profile.open()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">
        <div class="sidebar-avatar" id="sidebar-avatar">üë§</div>
        <div class="sidebar-info">
          <div class="sidebar-username" id="current-user-name">...</div>
          <div class="sidebar-status">AI Assistant</div>
        </div>
      </div>

      <button class="new-chat-btn" id="new-chat-btn"><span>+</span> –ù–æ–≤—ã–π —á–∞—Ç</button>

      <div class="search-box">
        <input type="text" id="chat-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏..." />
      </div>
    </div>

    <div class="chat-list" id="chat-list"></div>

    <div class="sidebar-footer">
      <button class="logout-btn-sidebar" onclick="Auth.logout()">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
        </svg>
        –í—ã–π—Ç–∏
      </button>
    </div>
  </aside>

  <!-- ========================= MAIN ========================= -->
  <main class="main-content">
    <div class="top-bar">
      <button class="icon-btn" id="menu-btn" title="–ú–µ–Ω—é">
        <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
      </button>

      <button class="icon-btn" id="profile-btn" onclick="Profile.open()" title="–ü—Ä–æ—Ñ–∏–ª—å">
        <div id="top-bar-avatar-content" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">üë§</div>
      </button>
    </div>

    <div class="scroll-container" id="main-scroll">
      <header id="welcome-header">
        <h1>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
        <div class="subtitle">–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–æ—Ç–æ üì∑ (–±—É–¥–µ—Ç ‚ÄúAnalyzing image‚Äù + —Å—Ç—Ä–∏–º –æ—Ç–≤–µ—Ç–∞)</div>
      </header>

      <div id="chat-stream"></div>
    </div>

    <!-- INPUT BAR -->
    <div class="input-sheet-container">
      <div class="input-avatar-btn" id="input-bar-avatar" onclick="Profile.open()">üë§</div>

      <div class="input-wrapper">
        <!-- camera -->
        <button class="mini-btn" id="camera-btn" title="–°—Ñ–æ—Ç–∫–∞—Ç—å / –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ">
          <svg viewBox="0 0 24 24"><path d="M20 5h-3.2l-1.2-2H8.4L7.2 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 14H4V7h4.05l1.2-2h5.5l1.2 2H20v12zM12 8c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>
        </button>
        <input id="camera-input" type="file" accept="image/*" capture="environment" />

        <!-- pending thumbnail -->
        <div class="pending-thumb" id="pending-thumb">
          <img id="pending-thumb-img" alt="pending" />
          <button id="pending-thumb-clear" title="–£–±—Ä–∞—Ç—å">√ó</button>
        </div>

        <input type="text" id="user-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />

        <!-- send/stop -->
        <button class="action-btn state-send" id="main-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å / –°—Ç–æ–ø">
          <div class="icon icon-send">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
          </div>
          <div class="icon icon-stop">
            <svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
          </div>
        </button>
      </div>
    </div>
  </main>

  <script>
    /* ==========================================================
       AUTH (localStorage users db)
    ========================================================== */
    const Auth = {
      currentUser: null,
      isRegistering: false,

      init() {
        const savedUser = localStorage.getItem('ai_current_user');
        if (savedUser) {
          this.currentUser = savedUser;
          this.closeAuthScreen();
          App.init(this.currentUser);
        } else {
          this.showAuthScreen();
        }
      },

      getDB() { return JSON.parse(localStorage.getItem('ai_users_db_v5') || '{}'); },
      saveDB(db) { localStorage.setItem('ai_users_db_v5', JSON.stringify(db)); },

      togglePasswordVisibility() {
        const input = document.getElementById('auth-password');
        input.setAttribute('type', input.getAttribute('type') === 'password' ? 'text' : 'password');
      },

      resetAllData() {
        if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –∞–∫–∫–∞—É–Ω—Ç—ã –∏ —á–∞—Ç—ã?")) {
          localStorage.clear();
          location.reload();
        }
      },

      action() {
        let nameInput = document.getElementById('auth-username').value.trim();
        const pass = document.getElementById('auth-password').value.trim();
        const errorEl = document.getElementById('auth-error');
        const db = this.getDB();

        if (!nameInput || !pass) {
          errorEl.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
          return;
        }

        if (nameInput.startsWith('@')) nameInput = nameInput.slice(1);

        const validNickRegex = /^[a-zA-Z0-9_]+$/;
        if (!validNickRegex.test(nameInput)) {
          errorEl.textContent = "–ù–∏–∫ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _";
          return;
        }

        const handle = '@' + nameInput.toLowerCase();

        if (this.isRegistering) {
          if (db[handle]) {
            errorEl.textContent = "–≠—Ç–æ—Ç @–Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç.";
            return;
          }
          db[handle] = {
            password: pass,
            avatar: { type: 'emoji', value: 'ü¶Ñ' },
            chats: []
          };
          this.saveDB(db);
          this.loginSuccess(handle);
        } else {
          if (!db[handle]) {
            errorEl.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.";
            return;
          }
          if (db[handle].password !== pass) {
            errorEl.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
            return;
          }
          this.loginSuccess(handle);
        }
      },

      loginSuccess(handle) {
        this.currentUser = handle;
        localStorage.setItem('ai_current_user', handle);

        document.getElementById('auth-username').value = '';
        document.getElementById('auth-password').value = '';
        document.getElementById('auth-error').textContent = '';

        this.closeAuthScreen();
        App.init(handle);
      },

      logout() {
        this.currentUser = null;
        localStorage.removeItem('ai_current_user');

        // stop any streams
        UI.stopStreaming(true);

        App.clearUI();
        Profile.close();

        this.showAuthScreen();
        UI.toggleSidebar(false);
      },

      toggleMode() {
        this.isRegistering = !this.isRegistering;
        document.getElementById('auth-title').textContent = this.isRegistering ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
        document.getElementById('auth-action-btn').textContent = this.isRegistering ? "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç" : "–í–æ–π—Ç–∏";
        document.getElementById('auth-toggle').innerHTML = this.isRegistering
          ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span>–í–æ–π—Ç–∏</span>'
          : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>';
        document.getElementById('auth-error').textContent = '';
      },

      showAuthScreen() { document.getElementById('auth-screen').classList.remove('hidden'); },
      closeAuthScreen() { document.getElementById('auth-screen').classList.add('hidden'); }
    };

    /* ==========================================================
       PROFILE (avatar in db)
    ========================================================== */
    const Profile = {
      open() {
        const db = Auth.getDB();
        const user = db[Auth.currentUser];
        if (!user) return;

        document.getElementById('profile-username').textContent = Auth.currentUser;
        this.renderAvatar('profile-avatar-display', user.avatar);

        document.getElementById('profile-modal').classList.add('active');
        UI.toggleSidebar(false);
      },

      close() {
        document.getElementById('profile-modal').classList.remove('active');
      },

      triggerUpload() {
        document.getElementById('avatar-upload').click();
      },

      handleFileUpload(event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        this.resizeImage(file, 180, 180, (dataUrl) => {
          this.saveAvatar('image', dataUrl);
        });

        event.target.value = '';
      },

      resizeImage(file, maxW, maxH, cb) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width, h = img.height;
            const ratio = Math.min(maxW / w, maxH / h, 1);
            w = Math.round(w * ratio);
            h = Math.round(h * ratio);

            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            cb(canvas.toDataURL('image/jpeg', 0.85));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      },

      setRandomEmoji() {
        const emojis = ['üëΩ','ü§ñ','ü¶ä','üêØ','ü¶Ñ','üê≤','üëª','ü§†','üòé','üëæ','üéÉ','üêº','ü¶Å'];
        const value = emojis[Math.floor(Math.random() * emojis.length)];
        this.saveAvatar('emoji', value);
      },

      saveAvatar(type, value) {
        const db = Auth.getDB();
        if (!db[Auth.currentUser]) return;

        db[Auth.currentUser].avatar = { type, value };
        Auth.saveDB(db);

        this.renderAvatar('profile-avatar-display', { type, value });
        App.updateAvatarsInUI();
      },

      renderAvatar(elementId, avatarData) {
        const el = document.getElementById(elementId);
        if (!el) return;

        el.innerHTML = '';
        if (avatarData && avatarData.type === 'image') {
          const img = document.createElement('img');
          img.src = avatarData.value;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.pointerEvents = 'none';
          el.appendChild(img);
        } else {
          el.textContent = (avatarData ? avatarData.value : 'üë§');
        }
      }
    };

    /* ==========================================================
       APP (chats, messages)
    ========================================================== */
    const App = {
      username: null,
      chats: [],
      activeChatId: null,

      init(username) {
        this.username = username;
        document.getElementById('current-user-name').textContent = username;

        const db = Auth.getDB();
        if (db[username] && !db[username].avatar) {
          db[username].avatar = { type: 'emoji', value: 'üë§' };
          Auth.saveDB(db);
        }

        this.chats = (db[username]?.chats) || [];
        this.updateAvatarsInUI();
        this.startNewChatSession();
        this.renderChatList();
      },

      clearUI() {
        this.username = null;
        this.chats = [];
        this.activeChatId = null;
        UI.clearScreen();
        UI.resetTrace();
        UI.clearPendingImage();
        document.getElementById('welcome-header').style.display = 'block';
        document.getElementById('chat-list').innerHTML = '';
        document.getElementById('current-user-name').textContent = '...';
      },

      updateAvatarsInUI() {
        const db = Auth.getDB();
        const user = db[this.username];
        if (!user) return;

        Profile.renderAvatar('sidebar-avatar', user.avatar);
        Profile.renderAvatar('top-bar-avatar-content', user.avatar);
        Profile.renderAvatar('input-bar-avatar', user.avatar);
      },

      sync() {
        const db = Auth.getDB();
        if (!db[this.username]) return;
        db[this.username].chats = this.chats;
        Auth.saveDB(db);
      },

      startNewChatSession() {
        // stop any running stream for safety
        UI.stopStreaming(true);

        this.activeChatId = null;
        UI.clearScreen();
        UI.resetTrace();
        document.getElementById('welcome-header').style.display = 'block';
        UI.toggleSidebar(false);

        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
      },

      ensureChatExists(firstMessageText) {
        if (this.activeChatId) return;

        const newId = Date.now().toString();
        const titleText = (firstMessageText || '–ù–æ–≤—ã–π —á–∞—Ç').trim();
        const title = titleText.substring(0, 25) + (titleText.length > 25 ? '...' : '');

        const chat = { id: newId, title, messages: [] };
        this.chats.unshift(chat);
        this.activeChatId = newId;
        this.sync();
        this.renderChatList();
      },

      addMessage(type, text, title = null, image = null) {
        if (type === 'user' && !this.activeChatId) {
          this.ensureChatExists(text || '–§–æ—Ç–æ');
        }
        const chat = this.chats.find(c => c.id === this.activeChatId);
        if (!chat) return;

        chat.messages.push({ type, text, title, image });
        this.sync();
      },

      switchChat(id) {
        if (this.activeChatId === id) { UI.toggleSidebar(false); return; }

        // stop active stream when switching
        UI.stopStreaming(true);

        this.activeChatId = id;
        const chat = this.chats.find(c => c.id === id);

        UI.clearScreen();
        UI.resetTrace();

        if (chat) {
          document.getElementById('welcome-header').style.display = 'none';
          chat.messages.forEach(msg => UI.renderMessage(msg.type, msg.text, msg.title, msg.image, false));
          setTimeout(() => UI.scrollToBottom(false), 50);
        }

        UI.toggleSidebar(false);
        this.renderChatList();
      },

      deleteChat(id, event) {
        event.stopPropagation();
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?')) return;

        this.chats = this.chats.filter(c => c.id !== id);
        this.sync();

        if (this.activeChatId === id) this.startNewChatSession();
        this.renderChatList();
      },

      renameChat(id, event) {
        event.stopPropagation();
        const chat = this.chats.find(c => c.id === id);
        if (!chat) return;

        const newName = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:", chat.title);
        if (!newName || !newName.trim()) return;

        chat.title = newName.trim();
        this.sync();
        this.renderChatList();
      },

      renderChatList() {
        const list = document.getElementById('chat-list');
        const filter = document.getElementById('chat-search').value.toLowerCase();
        list.innerHTML = '';

        this.chats.forEach(chat => {
          if (!chat.title.toLowerCase().includes(filter)) return;

          const el = document.createElement('div');
          el.className = `chat-item ${chat.id === this.activeChatId ? 'active' : ''}`;
          el.onclick = () => this.switchChat(chat.id);

          el.innerHTML = `
            <div class="chat-title">${escapeHtml(chat.title)}</div>
            <div class="chat-actions">
              <button class="action-icon" onclick="App.renameChat('${chat.id}', event)">‚úé</button>
              <button class="action-icon delete" onclick="App.deleteChat('${chat.id}', event)">‚úï</button>
            </div>
          `;
          list.appendChild(el);
        });
      }
    };

    /* ==========================================================
       UI + STREAMING + TRACE
       - One collapsible "Analyzing image" block
       - SSE streaming deltas into assistant message
       - STOP button closes EventSource immediately
    ========================================================== */
    const UI = {
      mainBtn: document.getElementById('main-btn'),
      inputField: document.getElementById('user-input'),
      chatStream: document.getElementById('chat-stream'),
      scrollContainer: document.getElementById('main-scroll'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),

      cameraBtn: document.getElementById('camera-btn'),
      cameraInput: document.getElementById('camera-input'),
      pendingThumb: document.getElementById('pending-thumb'),
      pendingThumbImg: document.getElementById('pending-thumb-img'),
      pendingThumbClear: document.getElementById('pending-thumb-clear'),
      pendingImageDataUrl: null,

      // trace block refs
      traceEl: null,
      traceBodyEl: null,
      traceOpen: true,

      // streaming message refs
      aiStreamRow: null,
      aiStreamTitleEl: null,
      aiStreamTextEl: null,
      streamedFullText: "",

      // EventSource for streaming
      es: null,
      currentJobId: null,

      // state
      isFetching: false,

      toggleSidebar(show) {
        if (show) {
          this.sidebar.classList.add('open');
          this.overlay.classList.add('active');
        } else {
          this.sidebar.classList.remove('open');
          this.overlay.classList.remove('active');
        }
      },

      clearScreen() {
        this.chatStream.innerHTML = '';
      },

      scrollToBottom(smooth = true) {
        this.scrollContainer.scrollTo({
          top: this.scrollContainer.scrollHeight,
          behavior: smooth ? 'smooth' : 'auto'
        });
      },

      setButtonState(state) {
        this.mainBtn.className = `action-btn state-${state}`;
        this.isFetching = (state === 'loading');
      },

      /* -------- Pending image (attach) -------- */
      setPendingImage(dataUrl) {
        this.pendingImageDataUrl = dataUrl;
        this.pendingThumbImg.src = dataUrl;
        this.pendingThumb.style.display = 'block';
      },

      clearPendingImage() {
        this.pendingImageDataUrl = null;
        this.pendingThumbImg.src = '';
        this.pendingThumb.style.display = 'none';
        this.cameraInput.value = '';
      },

      /* -------- Messages -------- */
      renderMessage(type, text, title = null, imageUrl = null, animate = true) {
        const rowDiv = document.createElement('div');
        rowDiv.className = `message-row ${type}`;

        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}`;

        if (type === 'user' && imageUrl) {
          msgDiv.style.background = 'transparent';
          msgDiv.style.boxShadow = 'none';
          msgDiv.style.padding = '0';

          const card = document.createElement('div');
          card.className = 'user-image-card';

          const img = document.createElement('img');
          img.src = imageUrl;

          const cap = document.createElement('div');
          cap.className = 'user-image-caption';
          cap.textContent = text || '–§–æ—Ç–æ';

          card.appendChild(img);
          card.appendChild(cap);
          msgDiv.appendChild(card);
        } else if (type === 'ai') {
          const safeTitle = title ? escapeHtml(title) : '';
          const safeText = text ? escapeHtml(text) : '';

          msgDiv.innerHTML = `
            <div class="result-card">
              ${safeTitle ? `<div class="result-title">${safeTitle}</div>` : ''}
              <div class="result-text">${safeText}</div>
            </div>
          `;
        } else {
          msgDiv.textContent = text || '';
        }

        rowDiv.appendChild(msgDiv);
        this.chatStream.appendChild(rowDiv);
        if (animate) this.scrollToBottom(true);
      },

      /* -------- TRACE (one block) -------- */
      resetTrace() {
        this.traceEl = null;
        this.traceBodyEl = null;
        this.traceOpen = true;
      },

      ensureTraceBlock() {
        if (this.traceEl && document.body.contains(this.traceEl)) return;

        const row = document.createElement('div');
        row.className = 'message-row ai';

        const card = document.createElement('div');
        card.className = 'trace-card';

        const head = document.createElement('div');
        head.className = 'trace-head';

        const left = document.createElement('div');
        left.innerHTML = `
          <div class="trace-title">üîé Analyzing image</div>
          <div class="trace-sub">–®–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (rotate / crop / enhance / AI)</div>
        `;

        const btn = document.createElement('button');
        btn.className = 'trace-btn';
        btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
        btn.onclick = () => {
          this.traceOpen = !this.traceOpen;
          this.traceBodyEl.style.display = this.traceOpen ? 'block' : 'none';
          btn.textContent = this.traceOpen ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å';
        };

        head.appendChild(left);
        head.appendChild(btn);

        const body = document.createElement('div');
        body.className = 'trace-body';

        card.appendChild(head);
        card.appendChild(body);

        row.appendChild(card);
        this.chatStream.appendChild(row);

        this.traceEl = card;
        this.traceBodyEl = body;
        this.traceOpen = true;

        this.scrollToBottom(true);
      },

      addTraceStep({ title, subtitle, code, preview_image }) {
        this.ensureTraceBlock();

        const step = document.createElement('div');
        step.className = 'trace-step';

        const t1 = document.createElement('div');
        t1.className = 't1';
        t1.textContent = title || 'Step';

        step.appendChild(t1);

        if (subtitle) {
          const t2 = document.createElement('div');
          t2.className = 't2';
          t2.textContent = subtitle;
          step.appendChild(t2);
        }

        if (code) {
          const pre = document.createElement('pre');
          pre.className = 'trace-code';
          pre.textContent = code;
          step.appendChild(pre);
        }

        if (preview_image) {
          const img = document.createElement('img');
          img.className = 'trace-preview';
          img.src = preview_image;
          step.appendChild(img);
        }

        this.traceBodyEl.appendChild(step);
        this.scrollToBottom(true);
      },

      /* -------- AI STREAM MESSAGE (delta tokens) -------- */
      startAIStreamMessage(title = "–û—Ç–≤–µ—Ç") {
        // one assistant bubble that will fill with streamed tokens
        const rowDiv = document.createElement('div');
        rowDiv.className = `message-row ai`;

        const msgDiv = document.createElement('div');
        msgDiv.className = `message ai`;

        msgDiv.innerHTML = `
          <div class="result-card">
            <div class="result-title">${escapeHtml(title)}</div>
            <div class="result-text"></div>
          </div>
        `;

        rowDiv.appendChild(msgDiv);
        this.chatStream.appendChild(rowDiv);

        this.aiStreamRow = rowDiv;
        this.aiStreamTitleEl = msgDiv.querySelector('.result-title');
        this.aiStreamTextEl = msgDiv.querySelector('.result-text');
        this.aiStreamTextEl.textContent = "";
        this.streamedFullText = "";

        this.scrollToBottom(true);
      },

      appendAIStreamDelta(delta) {
        if (!this.aiStreamTextEl) return;
        this.streamedFullText += delta;
        this.aiStreamTextEl.textContent = this.streamedFullText;

        if (this.streamedFullText.length % 60 === 0) {
          this.scrollToBottom(false);
        }
      },

      finishAIStream() {
        this.aiStreamRow = null;
        this.aiStreamTitleEl = null;
        this.aiStreamTextEl = null;
        this.scrollToBottom(true);
      },

      /* -------- STOP STREAMING (closes EventSource) -------- */
      stopStreaming(silent = false) {
        if (this.es) {
          try { this.es.close(); } catch {}
          this.es = null;
        }
        this.currentJobId = null;

        // back to send state
        this.setButtonState('send');

        // if user pressed stop, keep partial text visible
        if (!silent && this.streamedFullText) {
          // keep as-is; no extra system message
        }
      }
    };

    /* ==========================================================
       Helpers
    ========================================================== */
    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    async function fileToDataUrl(file, maxW = 1280, maxH = 1280, quality = 0.85) {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });

      let w = img.width, h = img.height;
      const ratio = Math.min(maxW / w, maxH / h, 1);
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      return canvas.toDataURL('image/jpeg', quality);
    }

    /* ==========================================================
       Server calls (FastAPI endpoints):
       POST /api/solve_start  -> { job_id }
       GET  /api/solve_stream/{job_id} (SSE) -> step/delta/final/error
    ========================================================== */
    async function startSolveJob({ text, imageDataUrl }) {
      const res = await fetch('/api/solve_start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text || '', image: imageDataUrl || null })
      });
      if (!res.ok) throw new Error('start job failed');
      return await res.json();
    }

    function streamSolveJob(jobId, onEvent) {
      // close previous
      UI.stopStreaming(true);

      UI.currentJobId = jobId;
      UI.es = new EventSource(`/api/solve_stream/${jobId}`);

      UI.es.onmessage = (e) => {
        let data = null;
        try { data = JSON.parse(e.data); } catch { data = { type: 'error', title:'–°–±–æ–π', text:'–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç SSE' }; }
        onEvent(data);

        if (data.type === 'final' || data.type === 'error') {
          UI.stopStreaming(true);
        }
      };

      UI.es.onerror = () => {
        UI.stopStreaming(true);
        onEvent({ type: 'error', title: '–°–±–æ–π', text: '–ü—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å—Ç—Ä–∏–º–æ–º (SSE).' });
      };
    }

    /* ==========================================================
       Smart local answers (optional)
    ========================================================== */
    function getSmartLocalResponse(query) {
      const lower = (query || '').toLowerCase().trim();
      if (!lower) return null;

      if (/^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Å–∞–ª–∞–º|—Å”ô–ª–µ–º)/.test(lower)) {
        return { title: "–ü—Ä–∏–≤–µ—Ç!", text: "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? –ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ üì∑" };
      }
      if (lower.includes('–∫—Ç–æ —Ç—ã')) {
        return { title: "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç", text: "–Ø —á–∞—Ç-–±–æ—Ç. –ú–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è –ø–æ —Ñ–æ—Ç–æ." };
      }
      if (/^[\d+\-*/().\s]+$/.test(lower)) {
        try {
          // –ø—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –∫–µ–π—Å–∞)
          const val = Function(`"use strict"; return (${lower})`)();
          return { title: "–†–µ–∑—É–ª—å—Ç–∞—Ç", text: `${lower} = ${val}` };
        } catch {}
      }
      return null;
    }

    /* ==========================================================
       Main request handler
    ========================================================== */
    async function handleUserRequest() {
      const text = UI.inputField.value.trim();
      const img = UI.pendingImageDataUrl;

      if (!text && !img) return;

      // If currently streaming -> pressing send should not happen; stop button handles it
      UI.inputField.value = '';
      UI.inputField.blur();
      document.getElementById('welcome-header').style.display = 'none';

      // user message
      UI.renderMessage('user', text || '–§–æ—Ç–æ', null, img, true);
      App.addMessage('user', text || '–§–æ—Ç–æ', null, img);

      // clear pending attach
      UI.clearPendingImage();

      // If no image and local answer exists -> quick answer
      if (!img) {
        const local = getSmartLocalResponse(text);
        if (local) {
          UI.setButtonState('send');
          UI.renderMessage('ai', local.text, local.title, null, true);
          App.addMessage('ai', local.text, local.title);
          return;
        }
      }

      // go server streaming
      UI.setButtonState('loading');

      try {
        const { job_id } = await startSolveJob({ text, imageDataUrl: img });

        // Prepare trace and stream bubble
        UI.ensureTraceBlock();
        UI.startAIStreamMessage("–û—Ç–≤–µ—Ç");

        // When streaming begins, show stop icon
        UI.setButtonState('stop');

        streamSolveJob(job_id, (ev) => {
          if (ev.type === 'step') {
            UI.addTraceStep(ev);
          } else if (ev.type === 'delta') {
            UI.appendAIStreamDelta(ev.delta || '');
          } else if (ev.type === 'final') {
            // finalize
            const finalText = (ev.text || UI.streamedFullText || '').trim();
            UI.setButtonState('send');
            UI.finishAIStream();

            // Save to chat history
            App.addMessage('ai', finalText, ev.title || '–û—Ç–≤–µ—Ç');
          } else if (ev.type === 'error') {
            UI.setButtonState('send');
            UI.finishAIStream();
            UI.renderMessage('ai', ev.text || '–û—à–∏–±–∫–∞', ev.title || '–°–±–æ–π', null, true);
            App.addMessage('ai', ev.text || '–û—à–∏–±–∫–∞', ev.title || '–°–±–æ–π');
          }
        });

      } catch (e) {
        UI.setButtonState('send');
        UI.renderMessage('ai', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å /api/solve_start –∏ —Å–µ—Ä–≤–µ—Ä.', '–°–±–æ–π', null, true);
        App.addMessage('ai', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.', '–°–±–æ–π');
      }
    }

    /* ==========================================================
       LISTENERS
    ========================================================== */
    // auth
    document.getElementById('auth-action-btn').addEventListener('click', () => Auth.action());
    document.getElementById('auth-toggle').addEventListener('click', () => Auth.toggleMode());

    // profile avatar upload
    document.getElementById('avatar-upload').addEventListener('change', (e) => Profile.handleFileUpload(e));

    // sidebar open/close
    document.getElementById('menu-btn').addEventListener('click', () => UI.toggleSidebar(true));
    document.getElementById('overlay').addEventListener('click', () => {
      UI.toggleSidebar(false);
      Profile.close();
    });

    // new chat / search
    document.getElementById('new-chat-btn').addEventListener('click', () => App.startNewChatSession());
    document.getElementById('chat-search').addEventListener('input', () => App.renderChatList());

    // camera attach
    UI.cameraBtn.addEventListener('click', () => UI.cameraInput.click());
    UI.pendingThumbClear.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      UI.clearPendingImage();
    });

    UI.cameraInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        const dataUrl = await fileToDataUrl(file, 1400, 1400, 0.85);
        UI.setPendingImage(dataUrl);
        UI.inputField.focus();
      } catch {
        UI.clearPendingImage();
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ üò¢");
      }
    });

    // main button (send/stop)
    UI.mainBtn.addEventListener('click', () => {
      // If streaming -> stop immediately
      if (UI.mainBtn.classList.contains('state-stop')) {
        UI.stopStreaming(false);
        return;
      }
      // If loading -> ignore
      if (UI.isFetching) return;

      handleUserRequest();
    });

    // enter key
    UI.inputField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (UI.mainBtn.classList.contains('state-stop')) return;
        if (UI.isFetching) return;
        handleUserRequest();
      }
    });

    // init
    Auth.init();
  </script>
</body>
</html>